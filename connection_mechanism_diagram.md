# ERC-20ä¸BatchNFTè¿æ¥æœºåˆ¶å›¾è§£

## ğŸ”— 1. åŒå‘æŒ‡é’ˆç³»ç»Ÿ

```
BatchNFT (ERC-721)                    ProjectToken (ERC-20)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TokenID: 1          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ batchId: 1          â”‚
â”‚ ProjectID: VCS-001  â”‚              â”‚ totalSupply: 100000 â”‚
â”‚ totalCredits: 100000â”‚              â”‚ name: CC-VCS001-2024â”‚
â”‚ issuedCredits: 100k â”‚              â”‚ symbol: CC-FOR-2024 â”‚
â”‚ retiredCredits: 25k â”‚              â”‚ totalRetired: 25000 â”‚
â”‚ tokenAddress: 0x... â”‚              â”‚ batchContract: 0x...â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ­ 2. åˆ›å»ºæµç¨‹è¯¦è§£

```
Step 1: é¡¹ç›®éªŒè¯ + BatchNFTé“¸é€ 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CarbonCreditBatch.mintBatchWithToken()                   â”‚
â”‚                                                          â”‚
â”‚ 1. éªŒè¯é¡¹ç›®æ•°æ® (Chainlink Functions)                     â”‚
â”‚ 2. é“¸é€ BatchNFT (ID=1)                                   â”‚
â”‚ 3. è°ƒç”¨TokenFactory.createProjectToken()                â”‚
â”‚ 4. å»ºç«‹åŒå‘æ˜ å°„å…³ç³»                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
Step 2: ProjectTokenè‡ªåŠ¨éƒ¨ç½²
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TokenFactory.createProjectToken()                       â”‚
â”‚                                                          â”‚
â”‚ 1. new ProjectToken(batchId=1, batchContract=0x...)     â”‚
â”‚ 2. è®¾ç½®ä»£å¸åç§°: "CarbonCredit-VCS001-2024"              â”‚
â”‚ 3. è®¾ç½®ä»£å¸ç¬¦å·: "CC-FOR-2024"                           â”‚
â”‚ 4. å»ºç«‹åå‘æŒ‡é’ˆ: batchId = 1                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
Step 3: æ˜ å°„å…³ç³»ç¡®è®¤
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŒå‘éªŒè¯                                                  â”‚
â”‚                                                          â”‚
â”‚ BatchNFT.batchToTokenContract[1] = ProjectTokenåˆçº¦åœ°å€   â”‚
â”‚ ProjectToken.batchId = 1                                â”‚
â”‚ ProjectToken.batchNftContract = BatchNFTåˆçº¦åœ°å€         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ 3. è¿è¡Œæ—¶æ•°æ®åŒæ­¥

```
ç”¨æˆ·æ“ä½œ: è´­ä¹° 1000 ä¸ª ProjectToken
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ProjectToken.mint(user, 1000)      â”‚
â”‚                                    â”‚
â”‚ 1. _mint(user, 1000)              â”‚
â”‚ 2. totalSupply = 1000             â”‚ 
â”‚ 3. è°ƒç”¨åŒæ­¥å‡½æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BatchNFT.updateIssuedCredits()     â”‚
â”‚                                    â”‚
â”‚ 1. éªŒè¯è°ƒç”¨è€…æƒé™                    â”‚
â”‚ 2. batchData[1].issuedCredits += 1000â”‚
â”‚ 3. è§¦å‘äº‹ä»¶é€šçŸ¥                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·æ“ä½œ: ç¢³æŠµæ¶ˆ 500 ä¸ª ProjectToken
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ProjectToken.retire(500, "reason") â”‚
â”‚                                    â”‚
â”‚ 1. _burn(user, 500)               â”‚
â”‚ 2. totalSupply = 500              â”‚
â”‚ 3. totalRetired = 500             â”‚
â”‚ 4. è°ƒç”¨åŒæ­¥å‡½æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BatchNFT.updateRetiredCredits()    â”‚
â”‚                                    â”‚
â”‚ 1. éªŒè¯è°ƒç”¨è€…æƒé™                    â”‚
â”‚ 2. batchData[1].retiredCredits += 500â”‚
â”‚ 3. ç”Ÿæˆé€€ä¼‘è¯ä¹¦                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”’ 4. æƒé™æ§åˆ¶æœºåˆ¶

```
è°å¯ä»¥è°ƒç”¨ä»€ä¹ˆå‡½æ•°ï¼Ÿ

BatchNFT åˆçº¦:
â”œâ”€â”€ mintBatchWithToken()     â† åªæœ‰æˆæƒçš„å‘è¡Œæ–¹
â”œâ”€â”€ updateIssuedCredits()    â† åªæœ‰å¯¹åº”çš„ProjectToken
â””â”€â”€ updateRetiredCredits()   â† åªæœ‰å¯¹åº”çš„ProjectToken

ProjectToken åˆçº¦:
â”œâ”€â”€ mint()                   â† åªæœ‰BatchNFTæˆ–æˆæƒåœ°å€
â”œâ”€â”€ retire()                 â† ä»»ä½•ä»£å¸æŒæœ‰è€…
â””â”€â”€ _beforeTokenTransfer()   â† è‡ªåŠ¨éªŒè¯BatchNFTè¿æ¥

TokenFactory åˆçº¦:
â””â”€â”€ createProjectToken()     â† åªæœ‰BatchNFTåˆçº¦
```

## ğŸ” 5. æ•°æ®éªŒè¯æœºåˆ¶

```
å®æ—¶éªŒè¯è¿æ¥æœ‰æ•ˆæ€§:

function validateConnection() returns (bool) {
    âœ… BatchNFT.ownerOf(batchId) != address(0)     // NFTå­˜åœ¨
    âœ… BatchNFT.batchToToken[batchId] == this      // æ­£å‘æ˜ å°„æ­£ç¡®  
    âœ… this.batchId == expectedBatchId             // åå‘æ˜ å°„æ­£ç¡®
    âœ… this.batchNftContract != address(0)        // åˆçº¦åœ°å€æœ‰æ•ˆ
    
    return true; // æ‰€æœ‰éªŒè¯é€šè¿‡
}

æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥:
âœ… BatchNFT.issuedCredits == ProjectToken.totalSupply()
âœ… BatchNFT.retiredCredits == ProjectToken.totalRetired
âœ… æ˜ å°„å…³ç³»åŒå‘ä¸€è‡´
```

## ğŸ’¡ 6. å…³é”®æŠ€æœ¯è¦ç‚¹

### A. åˆçº¦éƒ¨ç½²é¡ºåº
```
1. TokenFactory åˆçº¦
2. BatchNFT åˆçº¦ (å¼•ç”¨TokenFactory)
3. ProjectToken åˆçº¦ (é€šè¿‡FactoryåŠ¨æ€åˆ›å»º)
```

### B. åœ°å€å­˜å‚¨ç­–ç•¥
```
BatchNFT å­˜å‚¨:
â”œâ”€â”€ mapping(uint256 => address) batchToTokenContract
â””â”€â”€ æ¯ä¸ªBatchMetadata.projectTokenAddress

ProjectToken å­˜å‚¨:
â”œâ”€â”€ uint256 batchId
â”œâ”€â”€ address batchNftContract  
â””â”€â”€ address tokenFactory
```

### C. äº‹ä»¶åŒæ­¥
```
BatchNFT äº‹ä»¶:
- BatchMintedWithToken(batchId, tokenAddress, projectId)
- CreditsIssued(batchId, amount)
- CreditsRetired(batchId, amount)

ProjectToken äº‹ä»¶:
- Transfer(from, to, amount) // æ ‡å‡†ERC-20
- CarbonCreditsRetired(user, amount, reason)
```

## ğŸš¨ 7. é”™è¯¯å¤„ç†å’Œå®‰å…¨

```
å¸¸è§é”™è¯¯åœºæ™¯å’Œå¤„ç†:

âŒ å°è¯•åˆ›å»ºé‡å¤çš„ProjectToken
   â””â”€â”€ require(batchToToken[batchId] == address(0))

âŒ æ— æƒé™è°ƒç”¨åŒæ­¥å‡½æ•°  
   â””â”€â”€ modifier onlyProjectToken(batchId)

âŒ BatchNFTä¸å­˜åœ¨æˆ–æ— æ•ˆ
   â””â”€â”€ validateBatchConnection() è¿”å› false

âŒ æ•°æ®ä¸ä¸€è‡´
   â””â”€â”€ å®šæœŸè¿è¡ŒéªŒè¯è„šæœ¬æ£€æŸ¥
```

## ğŸ¯ 8. å®é™…ä½¿ç”¨ç¤ºä¾‹

```solidity
// å®Œæ•´çš„ä½¿ç”¨æµç¨‹
contract UsageExample {
    function demonstrateWorkflow() external {
        // 1. é¡¹ç›®æ–¹ç”³è¯·é“¸é€ 
        (uint256 batchId, address tokenAddr) = batchNft.mintBatchWithToken(
            projectOwner,
            "VCS-001-2024", 
            100000
        );
        
        // 2. å‘è¡Œæ–¹é“¸é€ ä»£å¸ç»™ç”¨æˆ·
        IProjectToken(tokenAddr).mint(user, 1000);
        
        // 3. ç”¨æˆ·äº¤æ˜“ä»£å¸ (æ ‡å‡†ERC-20)
        IERC20(tokenAddr).transfer(buyer, 500);
        
        // 4. ç”¨æˆ·è¿›è¡Œç¢³æŠµæ¶ˆ
        IProjectToken(tokenAddr).retire(100, "Personal carbon offset");
        
        // 5. éªŒè¯æ•°æ®åŒæ­¥
        (bool isValid,) = IProjectToken(tokenAddr).validateBatchConnection();
        require(isValid, "Data sync failed");
    }
}
```

è¿™ä¸ªæŠ€æœ¯æ¶æ„ç¡®ä¿äº†ERC-20å’ŒBatchNFTä¹‹é—´çš„ç´§å¯†è¿æ¥ï¼ŒåŒæ—¶ä¿æŒäº†æ•°æ®ä¸€è‡´æ€§å’Œç³»ç»Ÿå®‰å…¨æ€§ï¼